# Nome do workflow que aparece na aba "Actions" do GitHub
name: Manual Release Package

# Defini√ß√£o de quando o workflow √© disparado
on:
  # workflow_dispatch = disparo manual (bot√£o "Run workflow" no GitHub)
  workflow_dispatch:
    inputs:
      # Input que o usu√°rio vai informar ao rodar manualmente
      version:
        description: 'Vers√£o/tag a ser usada (ex: v1.2.0)'
        required: true               # Campo obrigat√≥rio
        default: 'v1.0.0'            # Valor padr√£o se o usu√°rio n√£o trocar

# Permiss√µes que o workflow tem no reposit√≥rio
permissions:
  contents: write   # precisa de write pra criar/atualizar release e subir assets

jobs:
  # Nome do job
  release:
    # Ambiente onde o job vai rodar
    runs-on: ubuntu-latest

    steps:
      # 1) Baixar o c√≥digo do reposit√≥rio
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # baixa todo o hist√≥rico de commits (necess√°rio pra tags, etc.)

      # 2) Criar a tag se ela ainda n√£o existir
      - name: Create tag if not exists
        run: |
          # L√™ o input "version" passado no disparo manual
          TAG="${{ github.event.inputs.version }}"
          echo "üîç Verificando se a tag ${TAG} existe..."
          
          # git rev-parse TAG verifica se a tag existe
          # >/dev/null 2>&1 = descarta qualquer sa√≠da (stdout e stderr)
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "üîñ Criando tag ${TAG}..."
            # Configura o usu√°rio do git para o commit/tag que ser√° criado pela Action
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            # Cria a tag anotada (-a) com mensagem (-m)
            git tag -a "$TAG" -m "Tag criada automaticamente para release"
            # Envia a tag para o reposit√≥rio remoto (origin)
            git push origin "$TAG"
          else
            # Se j√° existir, s√≥ informa
            echo "‚úÖ Tag ${TAG} j√° existe."
          fi

      # 3) Criar o arquivo ZIP do reposit√≥rio para anexar na release
      - name: Create release zip
        id: make_zip          # id do step (permite referenciar outputs, se quiser)
        run: |
          TAG="${{ github.event.inputs.version }}"
          ZIPNAME="repo-${TAG}.zip"
          echo "üì¶ Criando pacote ${ZIPNAME}..."
          # zip -r compacta recursivamente todo o repo
          # -x exclui os diret√≥rios .git e .github do zip
          zip -r "${ZIPNAME}" . -x ".git/*" ".github/*"
          # Salva o nome do zip em uma sa√≠da do step (GITHUB_OUTPUT)
          echo "ZIP=${ZIPNAME}" >> $GITHUB_OUTPUT
          # Lista o arquivo gerado com tamanho leg√≠vel (ls -lh)
          ls -lh "${ZIPNAME}"

      # 4) Criar ou atualizar a release e enviar o ZIP como asset
      - name: Create or update release and upload asset
        # Action pronta para criar releases no GitHub
        uses: softprops/action-gh-release@v1
        with:
          # Tag usada na release (cria se n√£o existir, atualiza se existir)
          tag_name: ${{ github.event.inputs.version }}
          # Nome ‚Äúbonito‚Äù da release
          name: "Release ${{ github.event.inputs.version }}"
          # Descri√ß√£o da release
          body: "Release autom√°tico contendo o pacote completo do reposit√≥rio (${{github.event.inputs.version }})."
          # Arquivo que ser√° anexado na release (asset)
          files: repo-${{ github.event.inputs.version }}.zip
          # Se o arquivo n√£o existir por algum motivo, n√£o falha o workflow
          fail_on_unmatched_files: false
        env:
          # Token padr√£o que o GitHub Actions injeta, usado para autenticar
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
